<!DOCTYPE html>
<html lang="en" class="sl-theme-dark">

<head>
    <meta charset="utf-8" />
    <title>ShYCalculator (Preact + Shoelace)</title>
    <base href="/" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description"
        content="High-performance .NET WASM Expression Evaluator with a premium industrial industrial theme." />
    <meta name="theme-color" content="#0f172a" />

    <!-- OpenGraph / Social Sharing -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="ShYCalculator - Industrial .NET WASM Engine" />
    <meta property="og:description"
        content="A blazingly fast expression evaluator with unit conversion support and a professional industrial aesthetic." />
    <meta property="og:image"
        content="https://raw.githubusercontent.com/nullzerovibe/ShYCalculator/main/docs/preview.png" />
    <meta property="og:url" content="https://nullzerovibe.github.io/ShYCalculator/" />
    <meta name="twitter:card" content="summary_large_image" />

    <!-- Shoelace (CDN) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.12.0/cdn/themes/light.css" />
    <script type="module"
        src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.12.0/cdn/shoelace-autoloader.js"></script>

    <!-- Custom Styles -->
    <link rel="stylesheet" href="index.css" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">

    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
    <link rel="manifest" href="/favicon/site.webmanifest">

    <!-- Import Map for Blazor (generated during publish) -->
    <script type="importmap"></script>

    <script>
        // Global Console Branding
        console.log(`%c
N u l l Z e r o V i b e
▄▀▀▄░█▀▀█░█▀▀▄░█▀▀ 
█░░░░█░░█░█░░█░█▀▀ 
▀▄▄▀░█▄▄█░█▄▄▀░█▄▄

 ░▒▒▓▓ LIFETIME OF SYNTAX // AGENTIC EVOLUTION ▓▓▒▒░ 
`, 'font-family: monospace; font-weight: bold; color: #00ffff;');
    </script>
</head>

<body>
    <!-- App Root -->
    <div id="app">
        <!-- Preact will mount here -->
        <div
            style="display: flex; height: 100vh; justify-content: center; align-items: center; color: #94a3b8; font-family: sans-serif;">
            Starting UI...
        </div>
    </div>

    <!-- Background Decoration -->
    <img src="nlo/nlo-banner.jpg" class="app-banner" alt="" style="display:none;">
    <!-- Hidden but kept for asset reference if needed -->

    <!-- Corner Links -->
    <a href="https://github.com/nullzerovibe/ShYCalculator" target="_blank">
        <img src="nlo/nlo-profile.png" alt="NullZeroVibe" class="corner-logo" />
    </a>

    <!-- Global Interop Setup (Must run before Blazor starts) -->
    <script>
        globalThis.shyCalculator = null;
        globalThis.registerShYCalculator = (dotNetHelper) => {
            console.log("ShYCalculator: .NET Instance Registered!", dotNetHelper);
            globalThis.shyCalculator = dotNetHelper;
            // Dispatch event for app.js to catch if it's already waiting
            globalThis.dispatchEvent(new CustomEvent('shy-calculator-ready', { detail: dotNetHelper }));
        };
    </script>

    <!-- Blazor Bootstrapper -->
    <script type="module">
        // --- DYNAMIC FILENAME RESOLVER & BLAZOR STARTER ---
        // Same logic as before to find the hashed blazor.webassembly.js
        (function () {
            let retries = 0;
            const maxRetries = 20;

            const loadEngine = () => {
                const mapTag = document.querySelector('script[type="importmap"]');
                let url = "_framework/blazor.webassembly.js"; // Fallback

                if (mapTag && mapTag.textContent.trim().length > 0) {
                    try {
                        const map = JSON.parse(mapTag.textContent);
                        // Try to find the blazor script in imports
                        for (const key in map.imports) {
                            if (key.includes("blazor.webassembly.js")) {
                                url = map.imports[key];
                                break;
                            }
                        }
                        console.log("Bootstrapper: Importmap found. URL:", url);
                    } catch (e) {
                        console.error("Bootstrapper: Importmap parse failed:", e);
                    }
                } else if (retries < maxRetries) {
                    // Importmap might not be populated yet if it's being injected late? 
                    // Usually it's static in index.html or injected by server.
                    // If static empty, use fallback immediately.
                    // If we suspect a race (unlikely in static hosting), wait.
                    // For now, proceed with fallback if empty.
                }

                console.log("Bootstrapper: Loading Blazor from", url);
                const script = document.createElement('script');
                script.src = url;
                script.type = "module";
                script.setAttribute('autostart', 'false');
                script.onload = () => {
                    console.log("Bootstrapper: Blazor script loaded. Starting...");
                    Blazor.start().then(() => {
                        console.log("Bootstrapper: Blazor started.");
                    }).catch(e => console.error("Bootstrapper: Blazor.start failed", e));
                };
                script.onerror = (e) => console.error("Bootstrapper: Script load failed", e);
                document.body.appendChild(script);
            };

            // Small delay to ensure DOM is ready and importmap (if any) is parsed
            setTimeout(loadEngine, 50);
        })();
    </script>

    <!-- Main UI Logic -->
    <script type="module" src="index.js"></script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => {
                        console.log('SW: Registered', reg);
                        // Check if already active or wait for it
                        if (reg.active) {
                            window.dispatchEvent(new CustomEvent('sw-ready'));
                        }
                        reg.addEventListener('updatefound', () => {
                            const newWorker = reg.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'activated') {
                                    window.dispatchEvent(new CustomEvent('sw-ready'));
                                }
                            });
                        });
                    })
                    .catch(err => console.error('SW: Registration failed', err));
            });
        }
    </script>
</body>

</html>