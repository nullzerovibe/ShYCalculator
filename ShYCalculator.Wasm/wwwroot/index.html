<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>ShYCalculator WASM</title>
    <base href="/" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Dynamic Filename Resolver will find the importmap during publish -->
    <script type="importmap"></script>
    <link rel="stylesheet" href="index.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
    <link rel="manifest" href="/favicon/site.webmanifest">
</head>

<body>
    <header class="app-banner">
        <img src="nlo/nlo-banner.jpg" alt="nullzerovibe banner" />
    </header>
    <div id="status" class="status-badge">Initializing .NET WASM Expression Evaluator...</div>

    <div id="app">
        <div class="card">
            <h1>ShYCalculator</h1>
            <p class="subtitle">High-performance .NET WASM Expression Evaluator</p>
            <div class="form-group" style="grid-template-columns: 1fr;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <label for="exampleSelect" style="margin-bottom: 0;">Load Example</label>
                    <button id="docsBtn" class="btn-small"
                        style="width: auto; background: transparent; border: 1px solid var(--glass-border); color: var(--text-muted); padding: 0.25rem 0.75rem; margin: 0;"
                        disabled>
                        ðŸ“– Reference Guide
                    </button>
                </div>
                <select id="exampleSelect">
                    <option value="">-- Select an Example --</option>
                    <optgroup label="Basic">
                        <option value="1 + 2 * 3">Simple Arithmetic</option>
                        <option value="10 / 2 + 5">Division & Addition</option>
                        <option value="2 ^ 3">Power (2^3)</option>
                    </optgroup>
                    <optgroup label="Scientific">
                        <option value="sin(0) + cos(0)">Trigonometry</option>
                        <option value="log(100, 10)">Logarithm (base 10)</option>
                        <option value="sqrt(16) + abs(-5)">Roots & Absolute</option>
                    </optgroup>
                    <optgroup label="Logic">
                        <option value="if(5 > 3, 100, 0)">Simple If/Else</option>
                        <option value="max(10, 20) + min(5, 1)">Max & Min</option>
                        <option value="true ? 1 : 0">Ternary Operator</option>
                    </optgroup>
                    <optgroup label="Formulas (Uses Variables)">
                        <option value="pi * r * r" data-vars='{"r": 5, "pi": 3.14159}'>Area of Circle</option>
                        <option value="a * a + b * b" data-vars='{"a": 3, "b": 4}'>Pythagoras (a^2 + b^2)</option>
                        <option value="offset + scale * x" data-vars='{"offset": 10, "scale": 2, "x": 5}'>Linear
                            Equation</option>
                    </optgroup>
                </select>
            </div>

            <div class="form-group">
                <label for="exprInput">Mathematical Expression</label>
                <input id="exprInput" type="text" placeholder="e.g. 1 + 2 * sin(0)" value="1 + 2 * sin(0)" />
            </div>

            <!-- Variables Section -->
            <div class="form-group">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span
                        style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0; margin-left: 0.25rem;">Variables
                        (Context)</span>
                    <button class="btn-small" id="addVarBtn">+ Add</button>
                </div>
                <div id="variablesContainer" style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <!-- Variable Rows will go here -->
                </div>
            </div>

            <button id="calcBtn" disabled>Calculate</button>

            <div class="result-container" id="resultBox" style="position: relative;">
                <div class="result-row">
                    <div class="result-value" id="output">---</div>
                    <button id="copyBtn" class="icon-btn" title="Copy Result" style="display: none;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round" style="width: 1.2rem; height: 1.2rem;">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                    </button>
                </div>
                <div class="result-meta-row">
                    <div class="result-label" id="resultLabel">Result will appear here</div>
                    <span id="execTimer" class="timer-badge" style="display: none;">0ms</span>
                </div>
            </div>

            <!-- History Section -->
            <div id="historySection" style="margin-top: 1.5rem; display: none;">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; border-bottom: 1px solid var(--glass-border); padding-bottom: 0.5rem;">
                    <span
                        style="display: block; font-weight: 600; margin-left: 0.25rem; margin-bottom: 0; font-size: 0.9rem; letter-spacing: 1px; color: var(--text-muted);">HISTORY</span>
                    <button class="btn-small" onclick="clearHistory()"
                        style="background: transparent; border: 1px solid var(--glass-border);">Clear</button>
                </div>
                <div id="historyList" class="history-list"></div>
            </div>
        </div>
    </div>

    <!-- Corner Elements -->
    <a href="https://github.com/nullzerovibe/ShYCalculator" target="_blank">
        <img src="nlo/nlo-profile.png" alt="NullZeroVibe Logo" class="corner-logo" />
    </a>

    <div class="corner-contact">
        <a href="mailto:nullzerovibe@gmail.com">
            <svg class="contact-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z" />
            </svg>
            nullzerovibe@gmail.com
        </a>
        <a href="https://github.com/nullzerovibe" target="_blank">
            <svg class="contact-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 2C6.47 2 2 6.47 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.89 1.52 2.34 1.08 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.09.39-1.98 1.03-2.68-.1-.25-.45-1.27.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.37.2 2.39.1 2.64.65.7 1.03 1.59 1.03 2.68 0 3.84-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0012 2z" />
            </svg>
            github.com/nullzerovibe
        </a>
    </div>

    <div id="docsModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2><span style="font-size: 1.2em; margin-right: 8px;">ðŸ“š</span>Reference Guide</h2>
                <button id="closeDocsBtn" class="close-btn">&times;</button>
            </div>
            <div class="tabs">
                <button class="tab-btn active" data-tab="functions">Functions</button>
                <button class="tab-btn" data-tab="operators">Operators</button>
                <button class="tab-btn" data-tab="settings">Settings</button>
            </div>
            <div class="modal-body" id="docsModalBody">

                <div id="functionsTab" class="tab-content active">
                    <div class="filter-controls">
                        <select id="funcCategoryFilter" class="modern-select">
                            <option value="">All Categories</option>
                        </select>
                        <button id="clearCatValues" class="icon-btn" title="Clear Filter"
                            style="background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); height: auto; width: 42px; display: flex; align-items: center; justify-content: center;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" style="width: 1.2rem; height: 1.2rem;">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    <div id="functionsList" class="docs-list">Loading...</div>
                </div>

                <div id="operatorsTab" class="tab-content" style="overflow-x: auto;">
                    <div id="operatorsList" class="docs-list">Loading...</div>
                </div>

                <div id="settingsTab" class="tab-content">
                    <div class="form-group">
                        <label for="dateFormatInput">Date Format (e.g. dd/MM/yyyy, MM-dd-yyyy)</label>
                        <div class="input-with-clear">
                            <input id="dateFormatInput" type="text" value="dd/MM/yyyy" class="modern-input" />
                            <button class="clear-input-btn" onclick="clearFormat()" title="Clear Format">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px;">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="chip-row">
                            <button class="chip-btn" onclick="setFormat('dd/MM/yyyy')">dd/MM/yyyy</button>
                            <button class="chip-btn" onclick="setFormat('MM/dd/yyyy')">MM/dd/yyyy</button>
                            <button class="chip-btn" onclick="setFormat('yyyy-MM-dd')">yyyy-MM-dd</button>
                            <button class="chip-btn" onclick="setFormat('d.M.yyyy')">d.M.yyyy</button>
                            <button class="chip-btn" onclick="setFormat('yyyy/MM/dd')">yyyy/MM/dd</button>
                            <button class="chip-btn" onclick="setFormat('d-M-yyyy')">d-M-yyyy</button>
                            <button class="chip-btn" onclick="setFormat('dd.MM.yyyy')">dd.MM.yyyy</button>
                            <button class="chip-btn" onclick="setFormat('yyyy.MM.dd')">yyyy.MM.dd</button>
                            <button class="chip-btn" onclick="setFormat('dd-MM-yyyy')">dd-MM-yyyy</button>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 1rem;">
                        <label for="cultureInput">Culture (e.g. en-US, en-GB, fr-FR)</label>
                        <div class="input-with-clear">
                            <input id="cultureInput" type="text" value="en-US" class="modern-input" />
                            <button class="clear-input-btn" onclick="clearCulture()" title="Clear Culture">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px;">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="chip-row">
                            <button class="chip-btn" onclick="setCulture('en-US')">ðŸ‡ºðŸ‡¸ US</button>
                            <button class="chip-btn" onclick="setCulture('en-GB')">ðŸ‡¬ðŸ‡§ UK</button>
                            <button class="chip-btn" onclick="setCulture('de-DE')">ðŸ‡©ðŸ‡ª DE</button>
                            <button class="chip-btn" onclick="setCulture('nl-NL')">ðŸ‡³ðŸ‡± NL</button>
                            <button class="chip-btn" onclick="setCulture('it-IT')">ðŸ‡®ðŸ‡¹ IT</button>
                            <button class="chip-btn" onclick="setCulture('hr-HR')">ðŸ‡­ðŸ‡· HR</button>
                            <button class="chip-btn" onclick="setCulture('es-ES')">ðŸ‡ªðŸ‡¸ ES</button>
                            <button class="chip-btn" onclick="setCulture('fr-FR')">ðŸ‡«ðŸ‡· FR</button>
                            <button class="chip-btn" onclick="setCulture('ru-RU')">ðŸ‡·ðŸ‡º RU</button>
                        </div>
                    </div>
                    <button id="saveSettingsBtn" class="btn-primary" style="margin-top: 1.5rem; width: 100%;">Save
                        Settings</button>
                    <div id="settingsMsg" style="margin-top: 0.5rem; font-size: 0.9rem; min-height: 1.2em;"></div>
                </div>
            </div>
            <!-- Scroll Top Button -->
            <button id="scrollTopBtn" class="scroll-top-btn" title="Go to top">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"
                    stroke-linejoin="round">
                    <path d="M18 15l-6-6-6 6" />
                </svg>
            </button>
        </div>
    </div>

    <div id="blazor-error-ui">
        An unhandled error has occurred. <a href="" class="reload">Reload</a>
    </div>

    <script>
        // Global handler for the .NET instance
        globalThis.shyCalculator = null;
        globalThis.registerShYCalculator = (dotNetHelper) => {
            console.log("ShYCalculator: .NET Instance Registered!", dotNetHelper);
            globalThis.shyCalculator = dotNetHelper;
        };
        console.log(`%c
N u l l Z e r o V i b e
â–„â–€â–€â–„â–‘â–ˆâ–€â–€â–ˆâ–‘â–ˆâ–€â–€â–„â–‘â–ˆâ–€â–€ 
â–ˆâ–‘â–‘â–‘â–‘â–ˆâ–‘â–‘â–ˆâ–‘â–ˆâ–‘â–‘â–ˆâ–‘â–ˆâ–€â–€ 
â–€â–„â–„â–€â–‘â–ˆâ–„â–„â–ˆâ–‘â–ˆâ–„â–„â–€â–‘â–ˆâ–„â–„

 â–‘â–’â–’â–“â–“ LIFETIME OF SYNTAX // AGENTIC EVOLUTION â–“â–“â–’â–’â–‘ 
`, 'font-family: monospace; font-weight: bold; color: #00ffff;');
    </script>
    <script type="module">
        // --- DYNAMIC FILENAME RESOLVER ---
        // Automatically finds the fingerprinted blazor.webassembly.js from the importmap
        globalThis.blazorInit = new Promise((resolve) => {
            let retries = 0;
            const maxRetries = 20;

            const loadEngine = () => {
                const mapTag = document.querySelector('script[type="importmap"]');
                let url = "_framework/blazor.webassembly.js"; // Standard fallback

                if (mapTag && mapTag.textContent.trim().length > 0) {
                    try {
                        const map = JSON.parse(mapTag.textContent);
                        url = map.imports["./_framework/blazor.webassembly.js"] || url;
                        console.log("ShYCalculator: Importmap found. Resolved URL:", url);
                    } catch (e) {
                        console.error("ShYCalculator: Failed to parse importmap:", e);
                    }
                } else if (retries < maxRetries) {
                    retries++;
                    setTimeout(loadEngine, 100);
                    return;
                } else {
                    console.warn("ShYCalculator: Importmap not found/empty after timeout. Using fallback:", url);
                }

                console.log("ShYCalculator: Injecting script tag for:", url);
                const script = document.createElement('script');
                script.src = url;
                script.type = "module";
                script.setAttribute('autostart', 'false');
                script.onload = () => {
                    console.log("ShYCalculator: Script loaded. Starting Blazor...");
                    resolve(Blazor.start());
                };
                script.onerror = (e) => console.error("ShYCalculator: Failed to load script:", url, e);
                document.body.appendChild(script);
            };
            loadEngine();
        });

        async function getInterop() {
            if (globalThis.shyCalculator) return globalThis.shyCalculator;
            // Wait for registration
            while (!globalThis.shyCalculator) {
                await new Promise(r => setTimeout(r, 50));
            }
            return globalThis.shyCalculator;
        }

        // Initialize UI after Wasm is ready
        await globalThis.blazorInit;
        const status = document.getElementById('status');
        const btn = document.getElementById('calcBtn');
        const addVarBtn = document.getElementById('addVarBtn');
        const variablesContainer = document.getElementById('variablesContainer');
        const exampleSelect = document.getElementById('exampleSelect');
        const exprInput = document.getElementById('exprInput');
        const docsBtn = document.getElementById('docsBtn');
        const docsModal = document.getElementById('docsModal');
        const closeDocsBtn = document.getElementById('closeDocsBtn');

        status.textContent = "Engine Ready";
        status.classList.add('ready');

        console.log("ShYCalculator: Waiting for interop registration...");
        try {
            const interop = await getInterop();
            const pong = await interop.invokeMethodAsync('Ping');
            console.log("ShYCalculator: Interop connection successful:", pong);

            // Enable UI
            btn.disabled = false;
            docsBtn.disabled = false;
        } catch (e) {
            console.error("ShYCalculator: Interop Ping failed:", e);
            status.textContent = "Engine Error";
            status.style.background = "var(--error)";
        }

        // --- Documentation Logic ---
        let docsLoaded = false;
        let allFunctions = []; // Store for filtering

        function showDocs() {
            docsModal.style.display = 'flex';
            if (!docsLoaded) {
                loadDocumentation();
            }
        }

        function hideDocs() {
            docsModal.style.display = 'none';
        }

        docsBtn.onclick = showDocs;
        closeDocsBtn.onclick = hideDocs;
        docsModal.onclick = (e) => {
            if (e.target === docsModal) hideDocs();
        };

        // Settings Logic
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const settingsMsg = document.getElementById('settingsMsg');

        globalThis.setFormat = (fmt) => document.getElementById('dateFormatInput').value = fmt;
        globalThis.setCulture = (cult) => document.getElementById('cultureInput').value = cult;
        globalThis.currentCulture = null; // Store for formatting

        saveSettingsBtn.onclick = async () => {
            const format = document.getElementById('dateFormatInput').value;
            const culture = document.getElementById('cultureInput').value;
            settingsMsg.textContent = "Saving...";

            // Update global culture for formatting
            globalThis.currentCulture = culture;
            settingsMsg.style.color = "var(--text-muted)";

            try {
                const interop = await getInterop();
                const result = await interop.invokeMethodAsync('ConfigureDates', format, culture);
                settingsMsg.textContent = "âœ… " + result;
                settingsMsg.style.color = "var(--success)";
            } catch (e) {
                console.error("Failed to save settings", e);
                settingsMsg.textContent = "âŒ Error: " + e.message;
                settingsMsg.style.color = "var(--error)";
            }
        };

        // Tab Switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab + 'Tab').classList.add('active');
            };
        });

        // Filter Logic
        const categoryFilter = document.getElementById('funcCategoryFilter');
        const clearCatValues = document.getElementById('clearCatValues');

        const applyFilter = () => {
            const cat = categoryFilter.value;
            const filtered = cat ? allFunctions.filter(f => f.Category === cat) : allFunctions;
            renderFunctions(filtered);
        };

        categoryFilter.onchange = applyFilter;

        clearCatValues.onclick = () => {
            categoryFilter.value = "";
            applyFilter();
        };

        // Operator Sorting
        let allOperators = [];
        let curOpSort = { key: 'Precedence', dir: 'desc' }; // Default sort

        function sortOperators(key) {
            if (curOpSort.key === key) {
                curOpSort.dir = curOpSort.dir === 'asc' ? 'desc' : 'asc';
            } else {
                curOpSort.key = key;
                curOpSort.dir = key === 'Precedence' ? 'desc' : 'asc';
            }
            applyOpSort();
        }
        globalThis.sortOperators = sortOperators;

        function applyOpSort() {
            const { key, dir } = curOpSort;
            const sorted = [...allOperators].sort((a, b) => {
                let valA = a[key];
                let valB = b[key];

                // Handle mixed types if necessary, though mostly strings/nums
                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();

                if (valA < valB) return dir === 'asc' ? -1 : 1;
                if (valA > valB) return dir === 'asc' ? 1 : -1;
                return 0;
            });
            renderOperators(sorted);
        }

        function getSortIcon(key) {
            if (curOpSort.key !== key) return '<span style="opacity:0.2">â†•</span>';
            return curOpSort.dir === 'asc' ? 'â†‘' : 'â†“';
        }

        async function loadDocumentation() {
            try {
                const interop = await getInterop();
                const json = await interop.invokeMethodAsync('GetDocumentation');
                const docs = JSON.parse(json);

                allFunctions = docs.functions;
                allOperators = docs.operators; // Store operators

                // Populate Categories
                const categories = [...new Set(allFunctions.map(f => f.Category).filter(Boolean))].sort();
                globalThis.setCulture = (val) => {
                    const input = document.getElementById('cultureInput');
                    if (input) {
                        input.value = val;
                        // Highlight effect
                        input.style.borderColor = 'var(--accent)';
                        setTimeout(() => input.style.borderColor = '', 300);
                    }
                };

                globalThis.clearFormat = () => {
                    const input = document.getElementById('dateFormatInput');
                    if (input) {
                        input.value = '';
                        input.focus();
                    }
                };

                globalThis.clearCulture = () => {
                    const input = document.getElementById('cultureInput');
                    if (input) {
                        input.value = '';
                        input.focus();
                    }
                };
                categories.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c;
                    opt.textContent = c;
                    categoryFilter.appendChild(opt);
                });

                renderFunctions(allFunctions);
                applyOpSort(); // Render with initial sort
                docsLoaded = true;
            } catch (e) {
                console.error("Failed to load docs", e);
                document.getElementById('functionsList').innerHTML = `<div class="error-msg">Failed to load documentation: ${e.message}</div>`;
            }
        }

        function renderFunctions(funcs) {
            const container = document.getElementById('functionsList');
            if (funcs.length === 0) {
                container.innerHTML = '<div class="empty-state">No functions found for this category.</div>';
                return;
            }
            container.innerHTML = funcs.map(f => `
                <div class="doc-item">
                    <div class="doc-header">
                        <span class="doc-name">${f.Name}</span>
                        <span class="doc-args">(${f.Arguments ? f.Arguments.join(', ') : ''})</span>
                        ${f.Category ? `<span class="doc-cat-tag">${f.Category}</span>` : ''}
                    </div>
                    <div class="doc-desc">${f.Description || 'No description available.'}</div>
                    ${f.Examples ? `
                        <div class="doc-examples">
                            ${f.Examples.map(ex => `<button class="example-chip" onclick="window.useExample('${ex.replaceAll('\'', "\\'")}')">${ex}</button>`).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function renderOperators(ops) {
            const container = document.getElementById('operatorsList');
            // Helper to create clickable header
            const th = (key, label) => `<th onclick="sortOperators('${key}')" style="cursor:pointer; user-select:none;">${label} ${getSortIcon(key)}</th>`;

            // Icons
            const icons = {
                left: `<svg viewBox="0 0 24 24" fill="none" class="contact-icon" style="width:1em;height:1em;vertical-align:text-bottom;margin-right:4px;"><path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
                right: `<svg viewBox="0 0 24 24" fill="none" class="contact-icon" style="width:1em;height:1em;vertical-align:text-bottom;margin-right:4px;"><path d="M5 12H19M19 12L12 5M19 12L12 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
                cat: {
                    'Arithmetic': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:1em;height:1em;vertical-align:text-bottom;margin-right:4px;"><path d="M4 12h16M12 4v16"/></svg>`, // Plus
                    'Comparison': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:1em;height:1em;vertical-align:text-bottom;margin-right:4px;"><path d="M6 9l12 0M6 15l12 0"/></svg>`, // Equal
                    'Bitwise': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:1em;height:1em;vertical-align:text-bottom;margin-right:4px;"><path d="M7 8h10M7 12h10M7 16h10"/></svg>`, // Binary-ish
                    'Unary': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:1em;height:1em;vertical-align:text-bottom;margin-right:4px;"><path d="M12 5v14M5 12h14"/></svg>`, // Plus (reused, maybe could be 1 dot?)
                    'Grouping': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:1em;height:1em;vertical-align:text-bottom;margin-right:4px;"><path d="M10 22c-5 0-7-5-7-10S5 2 10 2m4 0c5 0 7 5 7 10s-2 10-7 10"/></svg>` // Parentheses
                }
            };

            const getCatIcon = (cat) => icons.cat[cat] || `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:1em;height:1em;vertical-align:text-bottom;margin-right:4px;"><circle cx="12" cy="12" r="10"/></svg>`;

            container.innerHTML = `
                <table class="ops-table">
                    <thead>
                        <tr>
                            ${th('Symbol', 'Symbol')}
                            ${th('Name', 'Name')}
                            ${th('Category', 'Category')}
                            ${th('Precedence', 'Precedence')}
                            ${th('Associativity', 'Assoc')}
                        </tr>
                    </thead>
                    <tbody>
                        ${ops.map(o => {
                const assocIcon = o.Associativity === 'Left' ? icons.left : (o.Associativity === 'Right' ? icons.right : '');
                return `
                            <tr>
                                <td class="mono">${o.Symbol}</td>
                                <td>${o.Name}</td>
                                <td><span class="doc-cat-tag" style="display:inline-flex;align-items:center;">${getCatIcon(o.Category)}${o.Category}</span></td>
                                <td>${o.Precedence}</td>
                                <td><span style="display:inline-flex;align-items:center;">${assocIcon}${o.Associativity}</span></td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            `;
        }

        globalThis.useExample = (ex) => {
            document.getElementById('exprInput').value = ex;

            // Clear existing variables to ensure clean slate
            const variablesContainer = document.getElementById('variablesContainer');
            variablesContainer.innerHTML = '';

            // Auto-detect variables starting with $ (e.g. $current, $list)
            const varRegex = /\$([a-zA-Z0-9_]+)/g;
            const matches = ex.match(varRegex);

            if (matches) {
                // Deduplicate variables found in expression
                const uniqueVars = new Set(matches);
                uniqueVars.forEach(varName => {
                    addVariableRow(varName, '');
                });
            }

            hideDocs();
        };

        // --- Variable UI Helper ---
        function addVariableRow(key = '', val = '') {
            const row = document.createElement('div');
            row.className = 'var-row';
            row.style.display = 'grid';
            row.style.gridTemplateColumns = '1fr 1fr 30px';
            row.style.gap = '0.5rem';

            row.innerHTML = `
                <input type="text" placeholder="Name (e.g. x)" class="var-key" value="${key}">
                <input type="text" placeholder="Value" class="var-val" value="${val}">
                <button class="remove-var">Ã—</button>
            `;

            row.querySelector('.remove-var').onclick = () => row.remove();
            variablesContainer.appendChild(row);
        }

        addVarBtn.onclick = () => addVariableRow();

        // --- Example Loader ---
        exampleSelect.onchange = () => {
            const opt = exampleSelect.options[exampleSelect.selectedIndex];
            if (!opt.value) return;

            exprInput.value = opt.value;

            // Clear and Load variables if any
            variablesContainer.innerHTML = '';
            if (opt.dataset.vars) {
                try {
                    const vars = JSON.parse(opt.dataset.vars);
                    for (const [k, v] of Object.entries(vars)) {
                        addVariableRow(k, v);
                    }
                } catch (e) { console.error("Bad var data", e); }
            }
        };

        // History State
        let history = [];
        const MAX_HISTORY = 5;
        const historySection = document.getElementById('historySection');
        const historyList = document.getElementById('historyList');
        const execTimer = document.getElementById('execTimer');
        const copyBtn = document.getElementById('copyBtn');

        async function calculate() {
            const output = document.getElementById('output');
            const label = document.getElementById('resultLabel');
            const expr = document.getElementById('exprInput').value;
            const btn = document.getElementById('calcBtn');

            // Simple client-side check
            if (!expr.trim()) return;

            output.textContent = "Calculating...";
            label.textContent = "Processing...";
            label.style.color = "";
            output.className = "result-value"; // Reset classes
            output.style.color = "var(--text)";
            btn.disabled = true;

            // Reset UX elements
            copyBtn.style.display = 'none';
            execTimer.style.display = 'none';
            document.getElementById('resultBox').classList.remove('error', 'success');

            const startTime = performance.now();

            try {
                // Gather variables
                const vars = {};
                document.querySelectorAll('.var-row').forEach(row => {
                    const k = row.querySelector('.var-key').value.trim();
                    const rawVal = row.querySelector('.var-val').value.trim();

                    if (k) {
                        let v = rawVal;
                        // Tiered Parsing Logic
                        const lowerVal = rawVal.toLowerCase();
                        if (rawVal === '') {
                            return;
                        } else if (!Number.isNaN(Number(rawVal)) && rawVal !== '') {
                            v = Number(rawVal);
                        } else if (lowerVal === 'true') {
                            v = true;
                        } else if (lowerVal === 'false') {
                            v = false;
                        }
                        vars[k] = v;
                    }
                });

                const interop = await getInterop();
                let result;

                // Invoke .NET
                // Pass vars object directly, do not stringify. Blazor handles marshalling.
                result = await interop.invokeMethodAsync('CalculateWithVars', expr, vars);

                // Result is already an object, no need to JSON.parse

                const endTime = performance.now();
                const duration = (endTime - startTime).toFixed(1);
                execTimer.textContent = `${duration}ms`;
                execTimer.style.display = 'inline-block';

                if (result.success) {
                    let val;
                    if (result.nvalue !== null) val = result.nvalue;
                    else if (result.bvalue !== null) val = result.bvalue;
                    else if (result.dvalue === null || result.dvalue === undefined) { val = result.svalue; }
                    else {
                        // Use configured culture if available, otherwise browser default
                        val = new Date(result.dvalue).toLocaleString(globalThis.currentCulture || undefined);
                    }

                    // Allow null/undefined to show as "null"
                    if (val === undefined || val === null) val = "null";

                    output.textContent = val;
                    output.style.color = "var(--success)";

                    // Map DataType enum (1=Number, 2=Boolean, 4=Date, 8=String)
                    const typeMap = { 1: 'Number', 2: 'Boolean', 4: 'Date', 8: 'String' };
                    const typeName = typeMap[result.dataType] || 'Unknown';

                    label.textContent = `Type: ${typeName}`;
                    label.style.color = "";
                    document.getElementById('resultBox').classList.add('success');

                    // Show Copy Button
                    copyBtn.style.display = 'block';

                    // Add to History
                    addToHistory(expr, val);
                } else {
                    output.textContent = "Error";
                    output.style.color = "var(--error)";
                    label.textContent = result.message || "Unknown error";
                    label.style.color = "var(--error)";

                    if (result.errors && result.errors.length > 0) {
                        label.innerHTML = result.errors.map(e => `<div>${e.message}</div>`).join('');
                    }
                    document.getElementById('resultBox').classList.add('error');
                }
            } catch (err) {
                console.error("Interop error:", err);
                output.textContent = "System Error";
                output.style.color = "var(--error)";
                label.textContent = err.message;
                label.style.color = "var(--error)";
                document.getElementById('resultBox').classList.add('error');
            } finally {
                btn.disabled = false;
            }
        }

        // --- History Functions ---
        function addToHistory(expr, res) {
            history.unshift({ expr, res, time: new Date().toLocaleTimeString() });
            if (history.length > MAX_HISTORY) history.pop();
            renderHistory();
        }

        function renderHistory() {
            if (history.length === 0) {
                historySection.style.display = 'none';
                return;
            }
            historySection.style.display = 'block';
            historyList.innerHTML = history.map(item => {
                // Truncate less aggressively since we have a defined layout, but still needed for safety
                const displayExpr = item.expr.length > 40 ? item.expr.substring(0, 40) + '...' : item.expr;
                return `
                <div class="history-item" onclick="restoreHistory('${item.expr.replace(/'/g, "\\'")}')" title="${item.expr} = ${item.res}">
                    <div class="history-main">
                        <span class="history-expr">${displayExpr}</span>
                        <span class="history-val">= ${item.res}</span>
                    </div>
                    <div class="history-time">${item.time}</div>
                </div>
            `}).join('');
        }

        globalThis.clearHistory = () => {
            history = [];
            renderHistory();
        };

        globalThis.restoreHistory = (expr) => {
            document.getElementById('exprInput').value = expr;
            document.getElementById('exprInput').focus();
        };

        // --- Copy Function ---
        copyBtn.onclick = () => {
            navigator.clipboard.writeText(document.getElementById('output').textContent).then(() => {
                const original = copyBtn.innerHTML;
                copyBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 1.2rem; height: 1.2rem;"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
                setTimeout(() => copyBtn.innerHTML = original, 1500);
            });
        };

        // --- Keyboard Shortcuts ---
        document.addEventListener('keydown', (e) => {
            // Ctrl + Enter to Calculate
            if (e.ctrlKey && e.key === 'Enter') {
                calculate();
            }
            // Esc to Close Modal
            if (e.key === 'Escape') {
                const modal = document.getElementById('docsModal');
                if (modal.style.display === 'flex') {
                    modal.style.display = 'none';
                }
            }
        });

        document.getElementById('calcBtn').onclick = calculate;
        document.getElementById('exprInput').onkeypress = (e) => {
            if (e.key === 'Enter') calculate();
        };

        // Scroll Top Logic
        const modalBody = document.getElementById('docsModalBody');
        const scrollTopBtn = document.getElementById('scrollTopBtn');

        if (modalBody && scrollTopBtn) {
            modalBody.addEventListener('scroll', () => {
                if (modalBody.scrollTop > 300) {
                    scrollTopBtn.classList.add('visible');
                } else {
                    scrollTopBtn.classList.remove('visible');
                }
            });

            scrollTopBtn.addEventListener('click', () => {
                modalBody.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
    </script>
</body>

</html>