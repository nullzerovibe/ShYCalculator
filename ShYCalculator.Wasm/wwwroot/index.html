<!DOCTYPE html>
<html lang="en" class="sl-theme-dark">

<head>
    <meta charset="utf-8" />
    <title>ShYCalculator (Preact + Shoelace)</title>
    <base href="/" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description"
        content="High-performance .NET WASM Expression Evaluator with a premium industrial theme." />
    <meta name="theme-color" content="#0f172a" />

    <!-- OpenGraph / Social Sharing -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="ShYCalculator - Industrial .NET WASM Engine" />
    <meta property="og:description"
        content="A blazingly fast expression evaluator with unit conversion support and a professional industrial aesthetic." />
    <meta property="og:image"
        content="https://raw.githubusercontent.com/nullzerovibe/ShYCalculator/main/docs/preview.png" />
    <meta property="og:url" content="https://nullzerovibe.github.io/ShYCalculator/" />
    <meta name="twitter:card" content="summary_large_image" />

    <!-- Shoelace (CDN) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.12.0/cdn/themes/light.css" />
    <script type="module"
        src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.12.0/cdn/shoelace-autoloader.js"></script>

    <!-- Custom Styles -->
    <link rel="stylesheet" href="index.css" />


    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
    <link rel="manifest" href="/favicon/site.webmanifest">

    <!-- Import Map for Blazor (generated during publish) -->
    <script type="importmap"></script>

    <script>
        // Global Console Branding
        console.log(`%c
N u l l Z e r o V i b e
▄▀▀▄░█▀▀█░█▀▀▄░█▀▀ 
█░░░░█░░█░█░░█░█▀▀ 
▀▄▄▀░█▄▄█░█▄▄▀░█▄▄

 ░▒▒▓▓ LIFETIME OF SYNTAX // AGENTIC EVOLUTION ▓▓▒▒░ 
`, 'font-family: monospace; font-weight: bold; color: #00ffff;');
    </script>
</head>

<body class="is-booting">
    <!-- Boot Guard Splash Screen -->
    <div id="boot-splash" class="boot-splash">
        <img src="nlo/nlo-banner.jpg" class="splash-banner" alt="">
        <div class="splash-logo">ShYCalculator</div>
        <div class="splash-description">High-performance .NET WASM Expression Evaluator</div>
        <div class="splash-loader"></div>
        <div class="splash-status" id="boot-status">Initializing Engine...</div>
    </div>

    <!-- App Root -->
    <div id="app" v-cloak>
        <!-- Preact will mount here -->
    </div>

    <!-- Background Decoration -->
    <img src="nlo/nlo-banner.jpg" class="app-banner" alt="" style="display:none;">
    <!-- Hidden but kept for asset reference if needed -->

    <!-- Corner Links (Static) -->
    <div class="contact-footer">
        <a href="mailto:nullzerovibe@gmail.com" class="contact-link">
            <sl-icon name="envelope"></sl-icon>
            <span>nullzerovibe@gmail.com</span>
        </a>
        <a href="https://github.com/nullzerovibe" target="_blank" class="contact-link">
            <sl-icon name="github"></sl-icon>
            <span>github.com/nullzerovibe</span>
        </a>
        <a href="https://x.com/nullzerovibe" target="_blank" class="contact-link">
            <sl-icon name="twitter"></sl-icon>
            <span>x.com/nullzerovibe</span>
        </a>
    </div>

    <a href="https://github.com/nullzerovibe/ShYCalculator" target="_blank" class="corner-logo-wrapper">
        <img src="nlo/nlo-profile.png" alt="NullZeroVibe" class="corner-logo" />
    </a>

    <!-- Global Interop Setup (Must run before Blazor starts) -->
    <script>
        globalThis.shyCalculator = null;
        globalThis.registerShYCalculator = (dotNetHelper) => {
            console.log("ShYCalculator: .NET Instance Registered!", dotNetHelper);
            const status = document.getElementById('boot-status');
            if (status) status.textContent = 'Mounting UI...';

            globalThis.shyCalculator = dotNetHelper;
            // Dispatch event for app.js to catch if it's already waiting
            globalThis.dispatchEvent(new CustomEvent('shy-calculator-ready', { detail: dotNetHelper }));
        };
    </script>

    <!-- UI Boot Guard (Shoelace Definition Watcher) -->
    <script>
        (async () => {
            console.log("Boot Guard: Monitoring Shoelace Definitions...");
            const status = document.getElementById('boot-status');

            try {
                // Wait for core components to be defined by Shoelace Autoloader
                await Promise.all([
                    customElements.whenDefined('sl-button'),
                    customElements.whenDefined('sl-dialog'),
                    customElements.whenDefined('sl-card'),
                    customElements.whenDefined('sl-input'),
                    customElements.whenDefined('sl-icon')
                ]);

                console.log("Boot Guard: Shoelace components defined.");
                if (status) status.textContent = 'Engine Ready';

                // Once components are defined, lift the cloak and hide splash
                // We Wait a tiny bit extra for WASM if possible, but the app handles WASM load internally
                setTimeout(() => {
                    const app = document.getElementById('app');
                    const splash = document.getElementById('boot-splash');

                    if (app) app.removeAttribute('v-cloak');
                    if (splash) splash.classList.add('hidden');
                    document.body.classList.remove('is-booting');

                    console.log("Boot Guard: Cloak lifted. UI synchronized.");
                }, 150);

            } catch (e) {
                console.error("Boot Guard: Initialization failed!", e);
                if (status) status.textContent = 'Boot Error: ' + e.message;
            }
        })();
    </script>

    <!-- Blazor Bootstrapper -->
    <script type="module">
        // --- DYNAMIC FILENAME RESOLVER & BLAZOR STARTER ---
        // Same logic as before to find the hashed blazor.webassembly.js
        (function () {
            let retries = 0;
            const maxRetries = 20;

            const loadEngine = () => {
                const mapTag = document.querySelector('script[type="importmap"]');
                let url = "_framework/blazor.webassembly.js"; // Fallback

                if (mapTag && mapTag.textContent.trim().length > 0) {
                    try {
                        const map = JSON.parse(mapTag.textContent);
                        // Try to find the blazor script in imports
                        for (const key in map.imports) {
                            if (key.includes("blazor.webassembly.js")) {
                                url = map.imports[key];
                                break;
                            }
                        }
                        console.log("Bootstrapper: Importmap found. URL:", url);
                    } catch (e) {
                        console.error("Bootstrapper: Importmap parse failed:", e);
                    }
                } else if (retries < maxRetries) {
                    // Importmap might not be populated yet if it's being injected late? 
                    // Usually it's static in index.html or injected by server.
                    // If static empty, use fallback immediately.
                    // If we suspect a race (unlikely in static hosting), wait.
                    // For now, proceed with fallback if empty.
                }

                console.log("Bootstrapper: Loading Blazor from", url);
                const script = document.createElement('script');
                script.src = url;
                script.type = "module";
                script.setAttribute('autostart', 'false');
                script.onload = () => {
                    console.log("Bootstrapper: Blazor script loaded. Starting...");
                    Blazor.start().then(() => {
                        console.log("Bootstrapper: Blazor started.");
                    }).catch(e => console.error("Bootstrapper: Blazor.start failed", e));
                };
                script.onerror = (e) => console.error("Bootstrapper: Script load failed", e);
                document.body.appendChild(script);
            };

            // Small delay to ensure DOM is ready and importmap (if any) is parsed
            setTimeout(loadEngine, 50);
        })();
    </script>

    <!-- Main UI Logic -->
    <script type="module" src="index.js"></script>

    <script>
        if ('serviceWorker' in navigator) {
            globalThis.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => {
                        console.log('SW: Registered', reg);
                        // Check if already active or wait for it
                        if (reg.active) {
                            globalThis.dispatchEvent(new CustomEvent('sw-ready'));
                        }
                        reg.addEventListener('updatefound', () => {
                            const newWorker = reg.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'activated') {
                                    globalThis.dispatchEvent(new CustomEvent('sw-ready'));
                                }
                            });
                        });
                    })
                    .catch(err => console.error('SW: Registration failed', err));
            });
        }
    </script>
</body>

</html>